<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mood • Sedih</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>body{font-family:"Poppins",sans-serif}</style>
</head>

<body class="text-gray-800">
<header class="bg-[#e8b9c2] shadow-sm">
  <div class="container mx-auto flex items-center justify-between py-4 px-4 md:px-8">
    <a href="/" class="text-2xl font-extrabold tracking-wider text-yellow-600 select-none">MOOD COOK</a>
    <nav class="hidden md:flex gap-8 text-sm font-semibold uppercase">
      <a href="/"              class="hover:text-yellow-600">Beranda</a>
      <a href="#tentang"       class="hover:text-yellow-600">Tentang Kami</a>
      <a href="/recipe.html"   class="hover:text-yellow-600">Resep</a>
    </nav>
    <a id="nav-login" href="/login.html" class="hide-when-auth hidden md:inline-block bg-pink-300 text-white font-semibold px-6 py-2 rounded-full hover:bg-pink-400 transition">Masuk</a>
    <div id="user-box" class="relative hidden md:inline-block">
      <span id="nav-user" class="cursor-pointer font-semibold text-gray-700 select-none"></span>
      <div id="user-menu" class="hidden absolute right-0 mt-2 w-32 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
        <form method="POST" action="/api/logout">
          <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
        </form>
      </div>
    </div>
  </div>
</header>

<section class="pt-12 pb-10 text-center">
  <h2 class="text-xl md:text-2xl font-semibold leading-relaxed max-w-3xl mx-auto">Sedih itu wajar… Yuk, kita temani dengan makanan hangat<br />dan musik yang menenangkan</h2>
  <p class="mt-8 text-lg font-medium">Mood Kamu :</p>
  <div class="mt-4 flex flex-col items-center gap-4">
    <img src="assets/sedih.png" alt="Sad Mood" class="w-36 select-none" draggable="false" />
    <span class="text-lg font-semibold">Sedih</span>
  </div>
</section>

<section>
  <div class="bg-cyan-200/90 font-semibold text-center grid grid-cols-2 text-xs md:text-sm uppercase">
    <div class="py-3 border-b border-gray-400">Resep yang cocok untuk mood ini</div>
    <div class="py-3 border-b border-gray-400">Musik yang cocok buat suasana kamu</div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 px-6 md:px-20 py-10">
    <div id="recipe-list" class="flex flex-col items-center gap-10"></div>
    <div id="music-card" class="flex flex-col items-center text-center"><p class="text-sm text-gray-500">Memuat rekomendasi musik…</p></div>
  </div>
</section>

<footer class="bg-[#e8b9c2] py-10 text-center text-sm text-gray-100">&copy; 2025 Mood Cook</footer>
  <script>
    document.addEventListener("DOMContentLoaded", () => {

      /* util ambil user */
      function getUser() {
        if (window.__USER__) return window.__USER__;

        const ls = localStorage.getItem("user");
        if (ls) try { return JSON.parse(ls); } catch {}

        const m = document.cookie.match(/(?:^|;)\s*user=([^;]+)/);
        if (m) try { return JSON.parse(decodeURIComponent(m[1])); } catch {}

        return null;
      }

      const user = getUser();
      const isLoggedIn = !!user;

      /* Navbar & tombol auth */
      if (isLoggedIn) {
        const navUser = document.getElementById("nav-user");
        navUser.textContent = user.name;
        document.getElementById("user-box").classList.remove("hidden");
        document.querySelectorAll(".hide-when-auth").forEach(el => el.remove());

        /* === toggle dropdown === */
        const menu   = document.getElementById("user-menu");
        navUser.addEventListener("click", () => {
          menu.classList.toggle("hidden");
        });
        /* klik di mana saja untuk menutup */
        document.addEventListener("click", (e) => {
          if (!document.getElementById("user-box").contains(e.target))
            menu.classList.add("hidden");
        });
      }


      /* Tombol mood */
      document.querySelectorAll('.mood-btn').forEach(btn =>
        btn.addEventListener('click', e => {
          e.preventDefault();

          const slug = btn.dataset.mood;       // angry | happy | sad | bored
          const next = `/${slug}.html`;        // → /sad.html

          window.location.href = isLoggedIn
            ? next
            : `/login.html?next=${encodeURIComponent(next)}`;
        })
      );

      /* contoh fetch */
      fetch("/api/recipes").then(r=>r.json()).then(console.log);
    });
  </script>
<script>
/***** Auth util ringkas *****/
function getUser(){
  if(window.__USER__) return window.__USER__;
  try{return JSON.parse(localStorage.getItem('user'))}catch{}
  try{const m=document.cookie.match(/(?:^|;)\s*user=([^;]+)/);return m?JSON.parse(decodeURIComponent(m[1])):null}catch{}
  return null;
}
(function handleAuth(){
  const user=getUser(); if(!user) return;
  document.getElementById('nav-user').textContent=user.name;
  document.getElementById('user-box').classList.remove('hidden');
  document.querySelectorAll('.hide-when-auth').forEach(el=>el.remove());
  const menu=document.getElementById('user-menu');
  document.getElementById('nav-user').onclick=()=>menu.classList.toggle('hidden');
  window.addEventListener('click',e=>{if(!document.getElementById('user-box').contains(e.target))menu.classList.add('hidden');});
})();

/***** Dataset resep statis (bisa diganti fetch DB) *****/
const DEFAULT_RECIPES=[
  {id:'recipe-pedas-1', taste:'pedas', title:'Spicy Tuscan Chicken Pasta', img:'assets/pasta.png', link:'/recipe.html#recipe-pedas-1'},
  {id:'recipe-asin-1',  taste:'asin',  title:'Sheet Pan Chicken Fajitas',   img:'assets/fajitas.png', link:'/recipe.html#recipe-asin-1'},
  {id:'recipe-manis-1', taste:'manis', title:'Chocolate Chunk Coconut Pecan Skillet Cookie', img:'assets/cookie.png', link:'/recipe.html#recipe-manis-1'},
  // tambahkan resep lain di sini …
];

function pickRandom(arr,n){return[...arr].sort(()=>0.5-Math.random()).slice(0,n)}
function renderRecipes(recipes){
  const box=document.getElementById('recipe-list');
  if(!recipes.length){box.innerHTML='<p class="text-sm text-red-600">Belum ada resep cocok.</p>';return;}
  box.innerHTML='';
  recipes.forEach(r=>{
    const card=document.createElement('div');
    card.className='flex flex-col items-center text-center';
    card.innerHTML=`<img src="${r.img}" alt="${r.title}" class="w-full max-w-[320px] rounded-lg shadow" />\n      <p class="mt-4 font-semibold">${r.title}</p>\n      <a href="${r.link}" class="mt-3 inline-block px-8 py-2 rounded-full bg-emerald-600 text-white text-xs hover:bg-emerald-700">Lihat Resep</a>`;
    box.appendChild(card);
  });
}

async function fetchFoodPref(){
  // coba ambil dari localStorage dulu
  try{const cache=JSON.parse(localStorage.getItem('foodPref')||'null');if(cache)return cache;}catch{}
  // jika belum ada, fetch ke server
  const rsp=await fetch('/api/prefs/food');
  if(!rsp.ok) throw new Error('pref_fetch_error');
  const data=await rsp.json();
  localStorage.setItem('foodPref',JSON.stringify(data));
  return data;
}

(async function init(){
  let taste='manis';
  try{const pref=await fetchFoodPref(); if(pref && pref.sad) taste=pref.sad;}catch(err){console.warn(err)}
  const picks=pickRandom(DEFAULT_RECIPES.filter(r=>r.taste===taste),3);
  renderRecipes(picks);
})();

/***** Musik *****/
fetch('/api/recs?mood=sad')
  .then(r=>r.ok?r.json():Promise.reject('Tidak ada rekomendasi musik'))
  .then(t=>{
    const box=document.getElementById('music-card');
    box.innerHTML=`<iframe src="${t.embed}" class="w-full max-w-[320px] h-80 rounded-lg shadow" allow="encrypted-media; clipboard-write; picture-in-picture" loading="lazy"></iframe>\n<p class="mt-4 italic text-sm">${t.caption}</p>\n<a href="${t.uri}" target="_blank" rel="noopener" class="mt-3 inline-block px-8 py-2 rounded-full bg-rose-400 text-white text-xs hover:bg-rose-500">Putar Sekarang</a>`;
  })
  .catch(msg=>{document.getElementById('music-card').innerHTML=`<p class="text-sm text-red-600">${msg}</p>`});
</script>
</body>
</html>
